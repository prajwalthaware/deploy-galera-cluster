pipeline {
    agent any

    parameters {
        string(name: 'TARGET_HOSTS', description: 'Comma separated Galera node IPs (3 nodes)')
        string(name: 'ASYNC_HOST', description: 'Async slave node IP')
        string(name: 'PREFLIGHT_ID', description: 'Preflight ID from backend')
    }

    environment {
        SSH_KEY_PATH = '/var/lib/jenkins/.ssh/ansible_key'
        ANSIBLE_HOST_KEY_CHECKING = 'False'
        BACKEND_URL = 'http://192.168.56.1:3000'
    }

    stages {
        stage('Checkout') {
            steps {
                // This stage is just for visibility in the UI
                echo "✓ Repository checked out to workspace: ${env.WORKSPACE}"
                sh 'ls -la'
            }
        }

        stage('Generate Inventory') {
            steps {
                script {
                    echo "Generating Ansible inventory for preflight checks..."
                    
                    // Split comma-separated IPs into array
                    def galeraIps = params.TARGET_HOSTS.split(',')
                    
                    // Create inventory file
                    sh "echo '[mariadb_nodes]' > inventory_preflight.ini"
                    for (ip in galeraIps) {
                        sh "echo '${ip.trim()}' >> inventory_preflight.ini"
                    }
                    
                    sh "echo '' >> inventory_preflight.ini"
                    sh "echo '[async_node]' >> inventory_preflight.ini"
                    sh "echo '${params.ASYNC_HOST}' >> inventory_preflight.ini"
                    
                    sh """
                        echo '' >> inventory_preflight.ini
                        echo '[all:vars]' >> inventory_preflight.ini
                        echo 'ansible_user=user' >> inventory_preflight.ini
                        echo 'ansible_ssh_private_key_file=${SSH_KEY_PATH}' >> inventory_preflight.ini
                        echo 'ansible_python_interpreter=/usr/bin/python3.10' >> inventory_preflight.ini
                        echo 'preflight_id=${params.PREFLIGHT_ID}' >> inventory_preflight.ini
                    """
                    
                    // Display inventory for debugging
                    echo "Generated inventory:"
                    sh "cat inventory_preflight.ini"
                }
            }
        }

        stage('Run Preflight Checks') {
            steps {
                script {
                    echo "Running preflight checks on ${params.TARGET_HOSTS} and ${params.ASYNC_HOST}..."
                    
                    try {
                        sh """
                            sudo -E ansible-playbook -i inventory_preflight.ini test_preflight_playbook.yml \
                            --extra-vars "preflight_id=${params.PREFLIGHT_ID}"
                        """
                    } catch (Exception e) {
                        // Preflight playbook will handle sending failure to backend
                        echo "Preflight checks failed: ${e.message}"
                        currentBuild.result = 'FAILURE'
                        throw e
                    }
                }
            }
        }
    }

    post {
        success {
            echo "✅ Preflight checks completed successfully!"
            echo "Preflight ID: ${params.PREFLIGHT_ID}"
            echo "All nodes validated and ready for deployment"
        }
        failure {
            echo "❌ Preflight checks failed!"
            echo "Preflight ID: ${params.PREFLIGHT_ID}"
            echo "Check the results in the backend UI for detailed error information"
        }
        always {
            echo "Cleaning up temporary files..."
            sh 'rm -f inventory_preflight.ini'
        }
    }
}

